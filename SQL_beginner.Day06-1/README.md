# SQL Bootcamp: Day 06 — Улучшаем клиентский опыт

В этом проекте реализованы дополнительные бизнес-функции для модели данных pizzeria, а именно механизмы персональных скидок для клиентов. Цель — не только расширить логическую модель, но и обеспечить производительность, консистентность и удобство поддержки.

---

## Содержание

- [SQL Bootcamp: Day 06 — Улучшаем клиентский опыт](#sql-bootcamp-day-06--улучшаем-клиентский-опыт)
  - [Содержание](#содержание)
  - [Описание проекта](#описание-проекта)
  - [Структура БД](#структура-бд)
  - [Упражнения и решения](#упражнения-и-решения)
    - [Exercise 00 — Создание таблицы `person_discounts`](#exercise-00--создание-таблицы-person_discounts)
    - [Exercise 01 — Заполнение персональных скидок](#exercise-01--заполнение-персональных-скидок)
    - [Exercise 02 — Перерасчет истории заказов](#exercise-02--перерасчет-истории-заказов)
    - [Exercise 03 — Уникальный индекс для консистентности](#exercise-03--уникальный-индекс-для-консистентности)
    - [Exercise 04 — Ограничения и дефолты](#exercise-04--ограничения-и-дефолты)
    - [Exercise 05 — Комментарии для документации](#exercise-05--комментарии-для-документации)
    - [Exercise 06 — Генерация PK через `SEQUENCE`](#exercise-06--генерация-pk-через-sequence)

---

## Описание проекта

Проект демонстрирует, как добавить и внедрить новую бизнес-фичу — персональные скидки для клиентов пиццерий — в существующую PostgreSQL-модель данных. В процессе работы мы:

1. Создали новую таблицу `person_discounts` для хранения скидок.  
2. Написали скрипты DML/DDL для заполнения и изменения структуры.  
3. Обеспечили целостность данных через индексирование, ограничения и sequence.  
4. Добавили комментарии для лучшей документации.  

---

## Структура БД

- **pizzeria** — справочник пиццерий  
- **person** — справочник клиентов  
- **menu** — справочник пиццы и цен  
- **person_visits** — журнал посещений  
- **person_order** — журнал заказов  
- **person_discounts** — _новая_ таблица персональных скидок  

---

## Упражнения и решения

### Exercise 00 — Создание таблицы `person_discounts`

- Создана таблица с полями:
  - `id BIGINT` — PK  
  - `person_id BIGINT` — FK → `person(id)`  
  - `pizzeria_id BIGINT` — FK → `pizzeria(id)`  
  - `discount NUMERIC` — процент скидки  
- Добавлены явные имена FK-констрейнтов (`fk_person_discounts_person_id`, `fk_person_discounts_pizzeria_id`).

### Exercise 01 — Заполнение персональных скидок

- Запрос `INSERT … SELECT` на основе агрегированных данных из `person_order`:
  - 1 заказ → 10.5 %  
  - 2 заказа → 22 %  
  - ≥ 3 заказа → 30 %  
- Использована функция `ROW_NUMBER() OVER ()` для генерации PK.

### Exercise 02 — Перерасчет истории заказов

- Написан `SELECT` для вывода:
  - имени клиента  
  - названия пиццы и её базовой цены  
  - цены с учётом скидки (`ROUND(price * (1 – discount/100), 2)`)  
  - названия пиццерии  
- Сортировка: по имени клиента и названию пиццы.

### Exercise 03 — Уникальный индекс для консистентности

- Создан мультиколонный уникальный индекс `idx_person_discounts_unique (person_id, pizzeria_id)`  
- Продемонстрировано использование через `EXPLAIN ANALYZE` с отключённым последовательным сканом.

### Exercise 04 — Ограничения и дефолты

- Добавлены проверки NOT NULL для всех столбцов (`ch_nn_*`)  
- Установлен дефолт `discount DEFAULT 0`  
- Добавлено ограничение диапазона `CHECK (discount BETWEEN 0 AND 100)` (`ch_range_discount`).

### Exercise 05 — Комментарии для документации

- Добавлены комментарии `COMMENT ON …`:
  - для таблицы `person_discounts`  
  - для каждого столбца (цель, бизнес-логика, диапазон).

### Exercise 06 — Генерация PK через `SEQUENCE`

- Создана последовательность `seq_person_discounts START 1 INCREMENT 1`.  
- Установлен текущее значение `SETVAL` = `MAX(id) + 1`.  
- Для колонки `id` установлен дефолт `NEXTVAL('seq_person_discounts')`.

---
